{"ast":null,"code":"import _defineProperty from '@babel/runtime/helpers/defineProperty';\nimport _typeof from '@babel/runtime/helpers/typeof';\nimport _asyncToGenerator from '@babel/runtime/helpers/asyncToGenerator';\nimport _classCallCheck from '@babel/runtime/helpers/classCallCheck';\nimport _createClass from '@babel/runtime/helpers/createClass';\nimport _regeneratorRuntime from '@babel/runtime/regenerator';\nimport { generatePrivate, getPublic, decrypt } from '@toruslabs/eccrypto';\nimport { post, generateJsonRPCObject, get, setAPIKey, setEmbedHost } from '@toruslabs/http-helpers';\nimport BN from 'bn.js';\nimport { ec } from 'elliptic';\nimport JsonStringify from 'json-stable-stringify';\nimport { keccak256, toChecksumAddress } from 'web3-utils';\nimport loglevel from 'loglevel';\nimport _inherits from '@babel/runtime/helpers/inherits';\nimport _possibleConstructorReturn from '@babel/runtime/helpers/possibleConstructorReturn';\nimport _getPrototypeOf from '@babel/runtime/helpers/getPrototypeOf';\nimport _wrapNativeSuper from '@babel/runtime/helpers/wrapNativeSuper';\nimport _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';\nvar log = loglevel.getLogger('torus.js');\nlog.disableAll();\n\nfunction _createSuper$1(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct$1();\n\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _isNativeReflectConstruct$1() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nvar SomeError = /*#__PURE__*/function (_Error) {\n  _inherits(SomeError, _Error);\n\n  var _super = _createSuper$1(SomeError);\n\n  function SomeError(_ref) {\n    var _this;\n\n    var errors = _ref.errors,\n        responses = _ref.responses,\n        predicate = _ref.predicate;\n\n    _classCallCheck(this, SomeError);\n\n    _this = _super.call(this, 'Unable to resolve enough promises.');\n    _this.errors = errors;\n    _this.responses = responses;\n    _this.predicate = predicate;\n    return _this;\n  }\n\n  return _createClass(SomeError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\n\nvar Some = function Some(promises, predicate) {\n  return new Promise(function (resolve, reject) {\n    var finishedCount = 0;\n    var sharedState = {\n      resolved: false\n    };\n    var errorArr = new Array(promises.length).fill(undefined);\n    var resultArr = new Array(promises.length).fill(undefined);\n    var predicateError;\n    promises.forEach(function (x, index) {\n      x.then(function (resp) {\n        resultArr[index] = resp;\n        return undefined;\n      }).catch(function (error) {\n        errorArr[index] = error;\n      }).finally(function () {\n        if (sharedState.resolved) return;\n        predicate(resultArr.slice(0), sharedState).then(function (data) {\n          sharedState.resolved = true;\n          resolve(data);\n          return undefined;\n        }).catch(function (error) {\n          // log only the last predicate error\n          predicateError = error;\n        }).finally(function (_) {\n          finishedCount += 1;\n\n          if (finishedCount === promises.length) {\n            var errors = Object.values(resultArr.reduce(function (acc, z) {\n              var _error$data;\n\n              var _ref2 = z || {},\n                  id = _ref2.id,\n                  error = _ref2.error;\n\n              if ((error === null || error === void 0 ? void 0 : (_error$data = error.data) === null || _error$data === void 0 ? void 0 : _error$data.length) > 0) {\n                if (error.data.startsWith('Error occurred while verifying params')) acc[id] = capitalizeFirstLetter(error.data);else acc[id] = error.data;\n              }\n\n              return acc;\n            }, {}));\n\n            if (errors.length > 0) {\n              // Format-able errors\n              var msg = errors.length > 1 ? \"\\n\".concat(errors.map(function (it) {\n                return \"\\u2022 \".concat(it);\n              }).join('\\n')) : errors[0];\n              reject(new Error(msg));\n            } else {\n              var _predicateError;\n\n              reject(new SomeError({\n                errors: errorArr,\n                responses: resultArr,\n                predicate: ((_predicateError = predicateError) === null || _predicateError === void 0 ? void 0 : _predicateError.message) || predicateError\n              }));\n            }\n          }\n        });\n      });\n    });\n  });\n};\n\nfunction ownKeys$1(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread$1(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys$1(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys$1(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nvar GetOrSetNonceError = /*#__PURE__*/function (_Error) {\n  _inherits(GetOrSetNonceError, _Error);\n\n  var _super = _createSuper(GetOrSetNonceError);\n\n  function GetOrSetNonceError() {\n    _classCallCheck(this, GetOrSetNonceError);\n\n    return _super.apply(this, arguments);\n  }\n\n  return _createClass(GetOrSetNonceError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\n\nvar kCombinations = function kCombinations(s, k) {\n  var set = s;\n\n  if (typeof set === 'number') {\n    set = Array.from({\n      length: set\n    }, function (_, i) {\n      return i;\n    });\n  }\n\n  if (k > set.length || k <= 0) {\n    return [];\n  }\n\n  if (k === set.length) {\n    return [set];\n  }\n\n  if (k === 1) {\n    return set.reduce(function (acc, cur) {\n      return [].concat(_toConsumableArray(acc), [[cur]]);\n    }, []);\n  }\n\n  var combs = [];\n  var tailCombs = [];\n\n  for (var i = 0; i <= set.length - k + 1; i += 1) {\n    tailCombs = kCombinations(set.slice(i + 1), k - 1);\n\n    for (var j = 0; j < tailCombs.length; j += 1) {\n      combs.push([set[i]].concat(_toConsumableArray(tailCombs[j])));\n    }\n  }\n\n  return combs;\n};\n\nvar thresholdSame = function thresholdSame(arr, t) {\n  var hashMap = {};\n\n  for (var i = 0; i < arr.length; i += 1) {\n    var str = JsonStringify(arr[i]);\n    hashMap[str] = hashMap[str] ? hashMap[str] + 1 : 1;\n\n    if (hashMap[str] === t) {\n      return arr[i];\n    }\n  }\n\n  return undefined;\n};\n\nvar keyLookup = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(endpoints, verifier, verifierId) {\n    var lookupPromises;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            lookupPromises = endpoints.map(function (x) {\n              return post(x, generateJsonRPCObject('VerifierLookupRequest', {\n                verifier: verifier,\n                verifier_id: verifierId.toString()\n              })).catch(function (err) {\n                return log.error('lookup request failed', err);\n              });\n            });\n            return _context.abrupt(\"return\", Some(lookupPromises, function (lookupResults) {\n              var lookupShares = lookupResults.filter(function (x1) {\n                return x1;\n              });\n              var errorResult = thresholdSame(lookupShares.map(function (x2) {\n                return x2 && x2.error;\n              }), ~~(endpoints.length / 2) + 1);\n              var keyResult = thresholdSame(lookupShares.map(function (x3) {\n                return x3 && x3.result;\n              }), ~~(endpoints.length / 2) + 1);\n\n              if (keyResult || errorResult) {\n                return Promise.resolve({\n                  keyResult: keyResult,\n                  errorResult: errorResult\n                });\n              }\n\n              return Promise.reject(new Error(\"invalid results \".concat(JSON.stringify(lookupResults))));\n            }));\n\n          case 2:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function keyLookup(_x, _x2, _x3) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nvar waitKeyLookup = function waitKeyLookup(endpoints, verifier, verifierId, timeout) {\n  return new Promise(function (resolve, reject) {\n    setTimeout(function () {\n      keyLookup(endpoints, verifier, verifierId).then(resolve).catch(reject);\n    }, timeout);\n  });\n};\n\nvar keyAssign = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(endpoints, torusNodePubs, lastPoint, firstPoint, verifier, verifierId) {\n    var nodeNum, initialPoint, data, signedData, acceptedErrorMsgs;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (lastPoint === undefined) {\n              nodeNum = Math.floor(Math.random() * endpoints.length);\n              initialPoint = nodeNum;\n            } else {\n              nodeNum = lastPoint % endpoints.length;\n            }\n\n            if (!(nodeNum === firstPoint)) {\n              _context2.next = 3;\n              break;\n            }\n\n            throw new Error('Looped through all');\n\n          case 3:\n            if (firstPoint !== undefined) initialPoint = firstPoint;\n            data = generateJsonRPCObject('KeyAssign', {\n              verifier: verifier,\n              verifier_id: verifierId.toString()\n            });\n            _context2.prev = 5;\n            _context2.next = 8;\n            return post('https://signer.tor.us/api/sign', data, {\n              headers: {\n                pubKeyX: torusNodePubs[nodeNum].X,\n                pubKeyY: torusNodePubs[nodeNum].Y\n              }\n            }, {\n              useAPIKey: true\n            });\n\n          case 8:\n            signedData = _context2.sent;\n            return _context2.abrupt(\"return\", post(endpoints[nodeNum], _objectSpread$1(_objectSpread$1({}, data), signedData), {\n              headers: {\n                'Content-Type': 'application/json; charset=utf-8'\n              }\n            }));\n\n          case 12:\n            _context2.prev = 12;\n            _context2.t0 = _context2[\"catch\"](5);\n            log.error(_context2.t0);\n            acceptedErrorMsgs = [// Slow node\n            'Timed out', // Happens when the node is not reachable (dns issue etc)\n            'TypeError: Failed to fetch', // All except iOS and Firefox\n            'TypeError: cancelled', // iOS\n            'TypeError: NetworkError when attempting to fetch resource.' // Firefox\n            ];\n\n            if (!acceptedErrorMsgs.includes(_context2.t0.message)) {\n              _context2.next = 18;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", keyAssign(endpoints, torusNodePubs, nodeNum + 1, initialPoint, verifier, verifierId));\n\n          case 18:\n            throw new Error(\"Sorry, the Torus Network that powers Web3Auth is currently very busy.\\n    We will generate your key in time. Pls try again later. \\n\\n    \".concat(_context2.t0.message || ''));\n\n          case 19:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[5, 12]]);\n  }));\n\n  return function keyAssign(_x4, _x5, _x6, _x7, _x8, _x9) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n} // of Torus nodes to handle malicious node responses\n\n\nvar Torus = /*#__PURE__*/function () {\n  function Torus() {\n    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n        _ref$enableOneKey = _ref.enableOneKey,\n        enableOneKey = _ref$enableOneKey === void 0 ? false : _ref$enableOneKey,\n        _ref$metadataHost = _ref.metadataHost,\n        metadataHost = _ref$metadataHost === void 0 ? 'https://metadata.tor.us' : _ref$metadataHost,\n        _ref$allowHost = _ref.allowHost,\n        allowHost = _ref$allowHost === void 0 ? 'https://signer.tor.us/api/allow' : _ref$allowHost,\n        _ref$serverTimeOffset = _ref.serverTimeOffset,\n        serverTimeOffset = _ref$serverTimeOffset === void 0 ? 0 : _ref$serverTimeOffset;\n\n    _classCallCheck(this, Torus);\n\n    this.ec = new ec('secp256k1');\n    this.metadataHost = metadataHost;\n    this.allowHost = allowHost;\n    this.enableOneKey = enableOneKey;\n    this.serverTimeOffset = serverTimeOffset || 0; // ms\n  }\n\n  _createClass(Torus, [{\n    key: \"getUserTypeAndAddress\",\n    value:\n    /**\n     * Note: use this function only for openlogin tkey account lookups.\n     */\n    function () {\n      var _getUserTypeAndAddress = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(endpoints, torusNodePubs, _ref2) {\n        var verifier,\n            verifierId,\n            doesKeyAssign,\n            _ref3,\n            keyResult,\n            errorResult,\n            isNewKey,\n            finalKeyResult,\n            assignResult,\n            _finalKeyResult$keys$,\n            X,\n            Y,\n            typeOfUser,\n            nonce,\n            pubNonce,\n            modifiedPubKey,\n            upgraded,\n            _yield$this$getOrSetN,\n            finalX,\n            finalY,\n            address,\n            _args = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                verifier = _ref2.verifier, verifierId = _ref2.verifierId;\n                doesKeyAssign = _args.length > 3 && _args[3] !== undefined ? _args[3] : false;\n                _context.next = 4;\n                return keyLookup(endpoints, verifier, verifierId);\n\n              case 4:\n                _context.t0 = _context.sent;\n\n                if (_context.t0) {\n                  _context.next = 7;\n                  break;\n                }\n\n                _context.t0 = {};\n\n              case 7:\n                _ref3 = _context.t0;\n                keyResult = _ref3.keyResult;\n                errorResult = _ref3.errorResult;\n                isNewKey = false;\n\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier + VerifierID has not yet been assigned'))) {\n                  _context.next = 26;\n                  break;\n                }\n\n                if (doesKeyAssign) {\n                  _context.next = 14;\n                  break;\n                }\n\n                throw new Error('Verifier + VerifierID has not yet been assigned');\n\n              case 14:\n                _context.next = 16;\n                return keyAssign(endpoints, torusNodePubs, undefined, undefined, verifier, verifierId);\n\n              case 16:\n                _context.next = 18;\n                return waitKeyLookup(endpoints, verifier, verifierId, 1000);\n\n              case 18:\n                _context.t1 = _context.sent;\n\n                if (_context.t1) {\n                  _context.next = 21;\n                  break;\n                }\n\n                _context.t1 = {};\n\n              case 21:\n                assignResult = _context.t1;\n                finalKeyResult = assignResult.keyResult;\n                isNewKey = true;\n                _context.next = 31;\n                break;\n\n              case 26:\n                if (!keyResult) {\n                  _context.next = 30;\n                  break;\n                }\n\n                finalKeyResult = keyResult;\n                _context.next = 31;\n                break;\n\n              case 30:\n                throw new Error(\"node results do not match at first lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 31:\n                if (!finalKeyResult) {\n                  _context.next = 61;\n                  break;\n                }\n\n                _finalKeyResult$keys$ = finalKeyResult.keys[0], X = _finalKeyResult$keys$.pub_key_X, Y = _finalKeyResult$keys$.pub_key_Y;\n                _context.prev = 33;\n                _context.next = 37;\n                return this.getOrSetNonce(X, Y, undefined, !isNewKey);\n\n              case 37:\n                _yield$this$getOrSetN = _context.sent;\n                typeOfUser = _yield$this$getOrSetN.typeOfUser;\n                nonce = _yield$this$getOrSetN.nonce;\n                pubNonce = _yield$this$getOrSetN.pubNonce;\n                upgraded = _yield$this$getOrSetN.upgraded;\n                nonce = new BN(nonce || '0', 16);\n                _context.next = 48;\n                break;\n\n              case 45:\n                _context.prev = 45;\n                _context.t2 = _context[\"catch\"](33);\n                throw new GetOrSetNonceError();\n\n              case 48:\n                if (!(typeOfUser === 'v1')) {\n                  _context.next = 52;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n                _context.next = 57;\n                break;\n\n              case 52:\n                if (!(typeOfUser === 'v2')) {\n                  _context.next = 56;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPublic({\n                  x: pubNonce.x,\n                  y: pubNonce.y\n                }).getPublic());\n                _context.next = 57;\n                break;\n\n              case 56:\n                throw new Error('getOrSetNonce should always return typeOfUser.');\n\n              case 57:\n                finalX = modifiedPubKey.getX().toString(16);\n                finalY = modifiedPubKey.getY().toString(16);\n                address = this.generateAddressFromPubKey(modifiedPubKey.getX(), modifiedPubKey.getY());\n                return _context.abrupt(\"return\", {\n                  typeOfUser: typeOfUser,\n                  nonce: nonce,\n                  pubNonce: pubNonce,\n                  upgraded: upgraded,\n                  X: finalX,\n                  Y: finalY,\n                  address: address\n                });\n\n              case 61:\n                throw new Error(\"node results do not match at final lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 62:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[33, 45]]);\n      }));\n\n      function getUserTypeAndAddress(_x, _x2, _x3) {\n        return _getUserTypeAndAddress.apply(this, arguments);\n      }\n\n      return getUserTypeAndAddress;\n    }()\n  }, {\n    key: \"setCustomKey\",\n    value: function () {\n      var _setCustomKey = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref4) {\n        var privKeyHex, metadataNonce, torusKeyHex, customKeyHex, torusKey, privKey, customKey, newMetadataNonce, data;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                privKeyHex = _ref4.privKeyHex, metadataNonce = _ref4.metadataNonce, torusKeyHex = _ref4.torusKeyHex, customKeyHex = _ref4.customKeyHex;\n\n                if (torusKeyHex) {\n                  torusKey = new BN(torusKeyHex, 16);\n                } else {\n                  privKey = new BN(privKeyHex, 16);\n                  torusKey = privKey.sub(metadataNonce).umod(this.ec.curve.n);\n                }\n\n                customKey = new BN(customKeyHex, 16);\n                newMetadataNonce = customKey.sub(torusKey).umod(this.ec.curve.n);\n                data = this.generateMetadataParams(newMetadataNonce.toString(16), torusKey.toString(16));\n                _context2.next = 7;\n                return this.setMetadata(data);\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function setCustomKey(_x4) {\n        return _setCustomKey.apply(this, arguments);\n      }\n\n      return setCustomKey;\n    }()\n  }, {\n    key: \"retrieveShares\",\n    value: function () {\n      var _retrieveShares = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(endpoints, indexes, verifier, verifierParams, idToken) {\n        var _this = this;\n\n        var extraParams,\n            promiseArr,\n            tmpKey,\n            pubKey,\n            pubKeyX,\n            pubKeyY,\n            tokenCommitment,\n            i,\n            p,\n            _args5 = arguments;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                extraParams = _args5.length > 5 && _args5[5] !== undefined ? _args5[5] : {};\n                promiseArr = [];\n                _context5.next = 4;\n                return get(this.allowHost, {\n                  headers: {\n                    verifier: verifier,\n                    verifier_id: verifierParams.verifier_id\n                  }\n                }, {\n                  useAPIKey: true\n                });\n\n              case 4:\n                /*\n                  CommitmentRequestParams struct {\n                    MessagePrefix      string `json:\"messageprefix\"`\n                    TokenCommitment    string `json:\"tokencommitment\"`\n                    TempPubX           string `json:\"temppubx\"`\n                    TempPubY           string `json:\"temppuby\"`\n                    VerifierIdentifier string `json:\"verifieridentifier\"`\n                  } \n                  */\n                // generate temporary private and public key that is used to secure receive shares\n                tmpKey = generatePrivate();\n                pubKey = getPublic(tmpKey).toString('hex');\n                pubKeyX = pubKey.slice(2, 66);\n                pubKeyY = pubKey.slice(66);\n                tokenCommitment = keccak256(idToken); // make commitment requests to endpoints\n\n                for (i = 0; i < endpoints.length; i += 1) {\n                  p = post(endpoints[i], generateJsonRPCObject('CommitmentRequest', {\n                    messageprefix: 'mug00',\n                    tokencommitment: tokenCommitment.slice(2),\n                    temppubx: pubKeyX,\n                    temppuby: pubKeyY,\n                    verifieridentifier: verifier\n                  })).catch(function (err) {\n                    return log.error('commitment', err);\n                  });\n                  promiseArr.push(p);\n                }\n                /*\n                  ShareRequestParams struct {\n                    Item []bijson.RawMessage `json:\"item\"`\n                  }\n                  ShareRequestItem struct {\n                    IDToken            string          `json:\"idtoken\"`\n                    NodeSignatures     []NodeSignature `json:\"nodesignatures\"`\n                    VerifierIdentifier string          `json:\"verifieridentifier\"`\n                  }\n                  NodeSignature struct {\n                    Signature   string\n                    Data        string\n                    NodePubKeyX string\n                    NodePubKeyY string\n                  }\n                  CommitmentRequestResult struct {\n                    Signature string `json:\"signature\"`\n                    Data      string `json:\"data\"`\n                    NodePubX  string `json:\"nodepubx\"`\n                    NodePubY  string `json:\"nodepuby\"`\n                  }\n                  */\n                // send share request once k + t number of commitment requests have completed\n\n\n                return _context5.abrupt(\"return\", Some(promiseArr, function (resultArr) {\n                  var completedRequests = resultArr.filter(function (x) {\n                    if (!x || _typeof(x) !== 'object') {\n                      return false;\n                    }\n\n                    if (x.error) {\n                      return false;\n                    }\n\n                    return true;\n                  });\n\n                  if (completedRequests.length >= ~~(endpoints.length / 4) * 3 + 1) {\n                    return Promise.resolve(resultArr);\n                  }\n\n                  return Promise.reject(new Error(\"invalid \".concat(JSON.stringify(resultArr))));\n                }).then(function (responses) {\n                  var promiseArrRequest = [];\n                  var nodeSigs = [];\n\n                  for (var _i = 0; _i < responses.length; _i += 1) {\n                    if (responses[_i]) nodeSigs.push(responses[_i].result);\n                  }\n\n                  for (var _i2 = 0; _i2 < endpoints.length; _i2 += 1) {\n                    // eslint-disable-next-line promise/no-nesting\n                    var _p = post(endpoints[_i2], generateJsonRPCObject('ShareRequest', {\n                      encrypted: 'yes',\n                      item: [_objectSpread(_objectSpread({}, verifierParams), {}, {\n                        idtoken: idToken,\n                        nodesignatures: nodeSigs,\n                        verifieridentifier: verifier\n                      }, extraParams)]\n                    })).catch(function (err) {\n                      return log.error('share req', err);\n                    });\n\n                    promiseArrRequest.push(_p);\n                  }\n\n                  return Some(promiseArrRequest, /*#__PURE__*/function () {\n                    var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(shareResponses, sharedState) {\n                      var completedRequests, thresholdPublicKey, sharePromises, nodeIndex, _i3, metadata, sharesResolved, decryptedShares, allCombis, privateKey, _loop, j, _ret;\n\n                      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                        while (1) {\n                          switch (_context3.prev = _context3.next) {\n                            case 0:\n                              /*\n                                  ShareRequestResult struct {\n                                    Keys []KeyAssignment\n                                  }\n                                          / KeyAssignmentPublic -\n                                  type KeyAssignmentPublic struct {\n                                    Index     big.Int\n                                    PublicKey common.Point\n                                    Threshold int\n                                    Verifiers map[string][]string // Verifier => VerifierID\n                                  }\n                                   // KeyAssignment -\n                                  type KeyAssignment struct {\n                                    KeyAssignmentPublic\n                                    Share big.Int // Or Si\n                                  }\n                                */\n                              // check if threshold number of nodes have returned the same user public key\n                              completedRequests = shareResponses.filter(function (x) {\n                                return x;\n                              });\n                              thresholdPublicKey = thresholdSame(shareResponses.map(function (x) {\n                                return x && x.result && x.result.keys[0].PublicKey;\n                              }), ~~(endpoints.length / 2) + 1); // optimistically run lagrange interpolation once threshold number of shares have been received\n                              // this is matched against the user public key to ensure that shares are consistent\n\n                              if (!(completedRequests.length >= ~~(endpoints.length / 2) + 1 && thresholdPublicKey)) {\n                                _context3.next = 25;\n                                break;\n                              }\n\n                              sharePromises = [];\n                              nodeIndex = [];\n\n                              for (_i3 = 0; _i3 < shareResponses.length; _i3 += 1) {\n                                if (shareResponses[_i3] && shareResponses[_i3].result && shareResponses[_i3].result.keys && shareResponses[_i3].result.keys.length > 0) {\n                                  shareResponses[_i3].result.keys.sort(function (a, b) {\n                                    return new BN(a.Index, 16).cmp(new BN(b.Index, 16));\n                                  });\n\n                                  if (shareResponses[_i3].result.keys[0].Metadata) {\n                                    metadata = {\n                                      ephemPublicKey: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.ephemPublicKey, 'hex'),\n                                      iv: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.iv, 'hex'),\n                                      mac: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.mac, 'hex'),\n                                      mode: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.mode, 'hex')\n                                    };\n                                    sharePromises.push( // eslint-disable-next-line promise/no-nesting\n                                    decrypt(tmpKey, _objectSpread(_objectSpread({}, metadata), {}, {\n                                      ciphertext: Buffer.from(atob(shareResponses[_i3].result.keys[0].Share).padStart(64, '0'), 'hex')\n                                    })).catch(function (err) {\n                                      return log.debug('share decryption', err);\n                                    }));\n                                  } else {\n                                    sharePromises.push(Promise.resolve(Buffer.from(shareResponses[_i3].result.keys[0].Share.padStart(64, '0'), 'hex')));\n                                  }\n                                } else {\n                                  sharePromises.push(Promise.resolve(undefined));\n                                }\n\n                                nodeIndex.push(new BN(indexes[_i3], 16));\n                              }\n\n                              _context3.next = 8;\n                              return Promise.all(sharePromises);\n\n                            case 8:\n                              sharesResolved = _context3.sent;\n\n                              if (!sharedState.resolved) {\n                                _context3.next = 11;\n                                break;\n                              }\n\n                              return _context3.abrupt(\"return\", undefined);\n\n                            case 11:\n                              decryptedShares = sharesResolved.reduce(function (acc, curr, index) {\n                                if (curr) acc.push({\n                                  index: nodeIndex[index],\n                                  value: new BN(curr)\n                                });\n                                return acc;\n                              }, []); // run lagrange interpolation on all subsets, faster in the optimistic scenario than berlekamp-welch due to early exit\n                              // run lagrange interpolation on all subsets, faster in the optimistic scenario than berlekamp-welch due to early exit\n\n                              allCombis = kCombinations(decryptedShares.length, ~~(endpoints.length / 2) + 1);\n\n                              _loop = function _loop(j) {\n                                var currentCombi = allCombis[j];\n                                var currentCombiShares = decryptedShares.filter(function (v, index) {\n                                  return currentCombi.includes(index);\n                                });\n                                var shares = currentCombiShares.map(function (x) {\n                                  return x.value;\n                                });\n                                var indices = currentCombiShares.map(function (x) {\n                                  return x.index;\n                                });\n\n                                var derivedPrivateKey = _this.lagrangeInterpolation(shares, indices);\n\n                                var decryptedPubKey = getPublic(Buffer.from(derivedPrivateKey.toString(16, 64), 'hex')).toString('hex');\n                                var decryptedPubKeyX = decryptedPubKey.slice(2, 66);\n                                var decryptedPubKeyY = decryptedPubKey.slice(66);\n\n                                if (new BN(decryptedPubKeyX, 16).cmp(new BN(thresholdPublicKey.X, 16)) === 0 && new BN(decryptedPubKeyY, 16).cmp(new BN(thresholdPublicKey.Y, 16)) === 0) {\n                                  privateKey = derivedPrivateKey;\n                                  return \"break\";\n                                }\n                              };\n\n                              j = 0;\n\n                            case 15:\n                              if (!(j < allCombis.length)) {\n                                _context3.next = 22;\n                                break;\n                              }\n\n                              _ret = _loop(j);\n\n                              if (!(_ret === \"break\")) {\n                                _context3.next = 19;\n                                break;\n                              }\n\n                              return _context3.abrupt(\"break\", 22);\n\n                            case 19:\n                              j += 1;\n                              _context3.next = 15;\n                              break;\n\n                            case 22:\n                              if (!(privateKey === undefined)) {\n                                _context3.next = 24;\n                                break;\n                              }\n\n                              throw new Error('could not derive private key');\n\n                            case 24:\n                              return _context3.abrupt(\"return\", privateKey);\n\n                            case 25:\n                              throw new Error('invalid');\n\n                            case 26:\n                            case \"end\":\n                              return _context3.stop();\n                          }\n                        }\n                      }, _callee3);\n                    }));\n\n                    return function (_x10, _x11) {\n                      return _ref5.apply(this, arguments);\n                    };\n                  }());\n                }).then( /*#__PURE__*/function () {\n                  var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(returnedKey) {\n                    var privateKey, decryptedPubKey, decryptedPubKeyX, decryptedPubKeyY, metadataNonce, _yield$_this$getNonce, nonce, ethAddress;\n\n                    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n                      while (1) {\n                        switch (_context4.prev = _context4.next) {\n                          case 0:\n                            privateKey = returnedKey;\n                            decryptedPubKey = getPublic(Buffer.from(privateKey.toString(16, 64), 'hex')).toString('hex');\n                            decryptedPubKeyX = decryptedPubKey.slice(2, 66);\n                            decryptedPubKeyY = decryptedPubKey.slice(66);\n\n                            if (!_this.enableOneKey) {\n                              _context4.next = 12;\n                              break;\n                            }\n\n                            _context4.next = 7;\n                            return _this.getNonce(decryptedPubKeyX, decryptedPubKeyY, privateKey);\n\n                          case 7:\n                            _yield$_this$getNonce = _context4.sent;\n                            nonce = _yield$_this$getNonce.nonce;\n                            metadataNonce = new BN(nonce || '0', 16);\n                            _context4.next = 15;\n                            break;\n\n                          case 12:\n                            _context4.next = 14;\n                            return _this.getMetadata({\n                              pub_key_X: decryptedPubKeyX,\n                              pub_key_Y: decryptedPubKeyY\n                            });\n\n                          case 14:\n                            metadataNonce = _context4.sent;\n\n                          case 15:\n                            log.debug('> torus.js/retrieveShares', {\n                              privKey: privateKey.toString(16),\n                              metadataNonce: metadataNonce.toString(16)\n                            });\n                            privateKey = privateKey.add(metadataNonce).umod(_this.ec.curve.n);\n                            ethAddress = _this.generateAddressFromPrivKey(privateKey);\n                            log.debug('> torus.js/retrieveShares', {\n                              ethAddress: ethAddress,\n                              privKey: privateKey.toString(16)\n                            }); // return reconstructed private key and ethereum address\n\n                            return _context4.abrupt(\"return\", {\n                              ethAddress: ethAddress,\n                              privKey: privateKey.toString('hex', 64),\n                              metadataNonce: metadataNonce\n                            });\n\n                          case 20:\n                          case \"end\":\n                            return _context4.stop();\n                        }\n                      }\n                    }, _callee4);\n                  }));\n\n                  return function (_x12) {\n                    return _ref6.apply(this, arguments);\n                  };\n                }()));\n\n              case 11:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function retrieveShares(_x5, _x6, _x7, _x8, _x9) {\n        return _retrieveShares.apply(this, arguments);\n      }\n\n      return retrieveShares;\n    }()\n  }, {\n    key: \"getMetadata\",\n    value: function () {\n      var _getMetadata = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(data, options) {\n        var metadataResponse;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.prev = 0;\n                _context6.next = 3;\n                return post(\"\".concat(this.metadataHost, \"/get\"), data, options, {\n                  useAPIKey: true\n                });\n\n              case 3:\n                metadataResponse = _context6.sent;\n\n                if (!(!metadataResponse || !metadataResponse.message)) {\n                  _context6.next = 6;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\", new BN(0));\n\n              case 6:\n                return _context6.abrupt(\"return\", new BN(metadataResponse.message, 16));\n\n              case 9:\n                _context6.prev = 9;\n                _context6.t0 = _context6[\"catch\"](0);\n                log.error('get metadata error', _context6.t0);\n                return _context6.abrupt(\"return\", new BN(0));\n\n              case 13:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[0, 9]]);\n      }));\n\n      function getMetadata(_x13, _x14) {\n        return _getMetadata.apply(this, arguments);\n      }\n\n      return getMetadata;\n    }()\n  }, {\n    key: \"generateMetadataParams\",\n    value: function generateMetadataParams(message, privateKey) {\n      var key = this.ec.keyFromPrivate(privateKey.toString('hex', 64));\n      var setData = {\n        data: message,\n        timestamp: new BN(~~(this.serverTimeOffset + Date.now() / 1000)).toString(16)\n      };\n      var sig = key.sign(keccak256(JsonStringify(setData)).slice(2));\n      return {\n        pub_key_X: key.getPublic().getX().toString('hex'),\n        pub_key_Y: key.getPublic().getY().toString('hex'),\n        set_data: setData,\n        signature: Buffer.from(sig.r.toString(16, 64) + sig.s.toString(16, 64) + new BN(sig.v).toString(16, 2), 'hex').toString('base64')\n      };\n    }\n  }, {\n    key: \"setMetadata\",\n    value: function () {\n      var _setMetadata = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(data, options) {\n        var metadataResponse;\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.prev = 0;\n                _context7.next = 3;\n                return post(\"\".concat(this.metadataHost, \"/set\"), data, options, {\n                  useAPIKey: true\n                });\n\n              case 3:\n                metadataResponse = _context7.sent;\n                return _context7.abrupt(\"return\", metadataResponse.message);\n\n              case 7:\n                _context7.prev = 7;\n                _context7.t0 = _context7[\"catch\"](0);\n                log.error('set metadata error', _context7.t0);\n                return _context7.abrupt(\"return\", '');\n\n              case 11:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this, [[0, 7]]);\n      }));\n\n      function setMetadata(_x15, _x16) {\n        return _setMetadata.apply(this, arguments);\n      }\n\n      return setMetadata;\n    }()\n  }, {\n    key: \"lagrangeInterpolation\",\n    value: function lagrangeInterpolation(shares, nodeIndex) {\n      if (shares.length !== nodeIndex.length) {\n        return null;\n      }\n\n      var secret = new BN(0);\n\n      for (var i = 0; i < shares.length; i += 1) {\n        var upper = new BN(1);\n        var lower = new BN(1);\n\n        for (var j = 0; j < shares.length; j += 1) {\n          if (i !== j) {\n            upper = upper.mul(nodeIndex[j].neg());\n            upper = upper.umod(this.ec.curve.n);\n            var temp = nodeIndex[i].sub(nodeIndex[j]);\n            temp = temp.umod(this.ec.curve.n);\n            lower = lower.mul(temp).umod(this.ec.curve.n);\n          }\n        }\n\n        var delta = upper.mul(lower.invm(this.ec.curve.n)).umod(this.ec.curve.n);\n        delta = delta.mul(shares[i]).umod(this.ec.curve.n);\n        secret = secret.add(delta);\n      }\n\n      return secret.umod(this.ec.curve.n);\n    }\n  }, {\n    key: \"generateAddressFromPrivKey\",\n    value: function generateAddressFromPrivKey(privateKey) {\n      var key = this.ec.keyFromPrivate(privateKey.toString('hex', 64), 'hex');\n      var publicKey = key.getPublic().encode('hex').slice(2);\n      var ethAddressLower = \"0x\".concat(keccak256(Buffer.from(publicKey, 'hex')).slice(64 - 38));\n      return toChecksumAddress(ethAddressLower);\n    }\n  }, {\n    key: \"generateAddressFromPubKey\",\n    value: function generateAddressFromPubKey(publicKeyX, publicKeyY) {\n      var key = this.ec.keyFromPublic({\n        x: publicKeyX.toString('hex', 64),\n        y: publicKeyY.toString('hex', 64)\n      });\n      var publicKey = key.getPublic().encode('hex').slice(2);\n      var ethAddressLower = \"0x\".concat(keccak256(Buffer.from(publicKey, 'hex')).slice(64 - 38));\n      return toChecksumAddress(ethAddressLower);\n    }\n    /**\n     * Note: use this function only with custom auth, don't use to lookup openlogin accounts.\n     */\n\n  }, {\n    key: \"getPublicAddress\",\n    value: function () {\n      var _getPublicAddress = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(endpoints, torusNodePubs, _ref7) {\n        var verifier,\n            verifierId,\n            isExtended,\n            finalKeyResult,\n            isNewKey,\n            _ref8,\n            keyResult,\n            errorResult,\n            assignResult,\n            _nonce,\n            _finalKeyResult$keys$2,\n            X,\n            Y,\n            typeOfUser,\n            nonce,\n            pubNonce,\n            modifiedPubKey,\n            upgraded,\n            _yield$this$getOrSetN2,\n            address,\n            _args8 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                verifier = _ref7.verifier, verifierId = _ref7.verifierId;\n                isExtended = _args8.length > 3 && _args8[3] !== undefined ? _args8[3] : false;\n                log.debug('> torus.js/getPublicAddress', {\n                  endpoints: endpoints,\n                  torusNodePubs: torusNodePubs,\n                  verifier: verifier,\n                  verifierId: verifierId,\n                  isExtended: isExtended\n                });\n                isNewKey = false;\n                _context8.next = 6;\n                return keyLookup(endpoints, verifier, verifierId);\n\n              case 6:\n                _context8.t0 = _context8.sent;\n\n                if (_context8.t0) {\n                  _context8.next = 9;\n                  break;\n                }\n\n                _context8.t0 = {};\n\n              case 9:\n                _ref8 = _context8.t0;\n                keyResult = _ref8.keyResult;\n                errorResult = _ref8.errorResult;\n\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier not supported'))) {\n                  _context8.next = 16;\n                  break;\n                }\n\n                throw new Error(\"Verifier not supported. Check if you: \\n\\n      1. Are on the right network (Torus testnet/mainnet) \\n\\n      2. Have setup a verifier on dashboard.web3auth.io?\");\n\n              case 16:\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier + VerifierID has not yet been assigned'))) {\n                  _context8.next = 29;\n                  break;\n                }\n\n                _context8.next = 19;\n                return keyAssign(endpoints, torusNodePubs, undefined, undefined, verifier, verifierId);\n\n              case 19:\n                _context8.next = 21;\n                return waitKeyLookup(endpoints, verifier, verifierId, 1000);\n\n              case 21:\n                _context8.t1 = _context8.sent;\n\n                if (_context8.t1) {\n                  _context8.next = 24;\n                  break;\n                }\n\n                _context8.t1 = {};\n\n              case 24:\n                assignResult = _context8.t1;\n                finalKeyResult = assignResult.keyResult;\n                isNewKey = true;\n                _context8.next = 34;\n                break;\n\n              case 29:\n                if (!keyResult) {\n                  _context8.next = 33;\n                  break;\n                }\n\n                finalKeyResult = keyResult;\n                _context8.next = 34;\n                break;\n\n              case 33:\n                throw new Error(\"node results do not match at first lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 34:\n                log.debug('> torus.js/getPublicAddress', {\n                  finalKeyResult: finalKeyResult,\n                  isNewKey: isNewKey\n                });\n\n                if (!finalKeyResult) {\n                  _context8.next = 76;\n                  break;\n                }\n\n                _finalKeyResult$keys$2 = finalKeyResult.keys[0], X = _finalKeyResult$keys$2.pub_key_X, Y = _finalKeyResult$keys$2.pub_key_Y;\n\n                if (!this.enableOneKey) {\n                  _context8.next = 64;\n                  break;\n                }\n\n                _context8.prev = 38;\n                _context8.next = 42;\n                return this.getOrSetNonce(X, Y, undefined, !isNewKey);\n\n              case 42:\n                _yield$this$getOrSetN2 = _context8.sent;\n                typeOfUser = _yield$this$getOrSetN2.typeOfUser;\n                nonce = _yield$this$getOrSetN2.nonce;\n                pubNonce = _yield$this$getOrSetN2.pubNonce;\n                upgraded = _yield$this$getOrSetN2.upgraded;\n                nonce = new BN(nonce || '0', 16);\n                _context8.next = 53;\n                break;\n\n              case 50:\n                _context8.prev = 50;\n                _context8.t2 = _context8[\"catch\"](38);\n                throw new GetOrSetNonceError();\n\n              case 53:\n                if (!(typeOfUser === 'v1')) {\n                  _context8.next = 57;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n                _context8.next = 62;\n                break;\n\n              case 57:\n                if (!(typeOfUser === 'v2')) {\n                  _context8.next = 61;\n                  break;\n                }\n\n                if (upgraded) {\n                  // OneKey is upgraded to 2/n, returned address is address of Torus key (postbox key), not tKey\n                  modifiedPubKey = this.ec.keyFromPublic({\n                    x: X.toString(16),\n                    y: Y.toString(16)\n                  }).getPublic();\n                } else {\n                  modifiedPubKey = this.ec.keyFromPublic({\n                    x: X.toString(16),\n                    y: Y.toString(16)\n                  }).getPublic().add(this.ec.keyFromPublic({\n                    x: pubNonce.x,\n                    y: pubNonce.y\n                  }).getPublic());\n                }\n\n                _context8.next = 62;\n                break;\n\n              case 61:\n                throw new Error('getOrSetNonce should always return typeOfUser.');\n\n              case 62:\n                _context8.next = 69;\n                break;\n\n              case 64:\n                typeOfUser = 'v1';\n                _context8.next = 67;\n                return this.getMetadata({\n                  pub_key_X: X,\n                  pub_key_Y: Y\n                });\n\n              case 67:\n                nonce = _context8.sent;\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n\n              case 69:\n                X = modifiedPubKey.getX().toString(16);\n                Y = modifiedPubKey.getY().toString(16);\n                address = this.generateAddressFromPubKey(modifiedPubKey.getX(), modifiedPubKey.getY());\n                log.debug('> torus.js/getPublicAddress', {\n                  X: X,\n                  Y: Y,\n                  address: address,\n                  typeOfUser: typeOfUser,\n                  nonce: (_nonce = nonce) === null || _nonce === void 0 ? void 0 : _nonce.toString(16),\n                  pubNonce: pubNonce\n                });\n\n                if (isExtended) {\n                  _context8.next = 75;\n                  break;\n                }\n\n                return _context8.abrupt(\"return\", address);\n\n              case 75:\n                return _context8.abrupt(\"return\", {\n                  typeOfUser: typeOfUser,\n                  address: address,\n                  X: X,\n                  Y: Y,\n                  metadataNonce: nonce,\n                  pubNonce: pubNonce\n                });\n\n              case 76:\n                throw new Error(\"node results do not match at final lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 77:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[38, 50]]);\n      }));\n\n      function getPublicAddress(_x17, _x18, _x19) {\n        return _getPublicAddress.apply(this, arguments);\n      }\n\n      return getPublicAddress;\n    }()\n    /**\n     * Internal functions for OneKey (OpenLogin v2), only call these functions if you know what you're doing\n     */\n\n  }, {\n    key: \"getOrSetNonce\",\n    value: function () {\n      var _getOrSetNonce = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9(X, Y, privKey) {\n        var getOnly,\n            data,\n            msg,\n            _args9 = arguments;\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                getOnly = _args9.length > 3 && _args9[3] !== undefined ? _args9[3] : false;\n                msg = getOnly ? 'getNonce' : 'getOrSetNonce';\n\n                if (privKey) {\n                  data = this.generateMetadataParams(msg, privKey);\n                } else {\n                  data = {\n                    pub_key_X: X,\n                    pub_key_Y: Y,\n                    set_data: {\n                      data: msg\n                    }\n                  };\n                }\n\n                return _context9.abrupt(\"return\", post(\"\".concat(this.metadataHost, \"/get_or_set_nonce\"), data, undefined, {\n                  useAPIKey: true\n                }));\n\n              case 4:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function getOrSetNonce(_x20, _x21, _x22) {\n        return _getOrSetNonce.apply(this, arguments);\n      }\n\n      return getOrSetNonce;\n    }()\n  }, {\n    key: \"getNonce\",\n    value: function () {\n      var _getNonce = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10(X, Y, privKey) {\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                return _context10.abrupt(\"return\", this.getOrSetNonce(X, Y, privKey, true));\n\n              case 1:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function getNonce(_x23, _x24, _x25) {\n        return _getNonce.apply(this, arguments);\n      }\n\n      return getNonce;\n    }()\n  }, {\n    key: \"getPostboxKeyFrom1OutOf1\",\n    value: function getPostboxKeyFrom1OutOf1(privKey, nonce) {\n      var privKeyBN = new BN(privKey, 16);\n      var nonceBN = new BN(nonce, 16);\n      return privKeyBN.sub(nonceBN).umod(this.ec.curve.n).toString('hex');\n    }\n  }], [{\n    key: \"enableLogging\",\n    value: function enableLogging() {\n      var v = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      if (v) log.enableAll();else log.disableAll();\n    }\n  }, {\n    key: \"setAPIKey\",\n    value: function setAPIKey$1(apiKey) {\n      setAPIKey(apiKey);\n    }\n  }, {\n    key: \"setEmbedHost\",\n    value: function setEmbedHost$1(embedHost) {\n      setEmbedHost(embedHost);\n    }\n  }, {\n    key: \"isGetOrSetNonceError\",\n    value: function isGetOrSetNonceError(err) {\n      return err instanceof GetOrSetNonceError;\n    }\n  }]);\n\n  return Torus;\n}();\n\nexport { Torus as default, keyAssign, keyLookup, waitKeyLookup };","map":{"version":3,"sources":["/Users/advityasood/jude_anyft/node_modules/@toruslabs/torus.js/dist/torusUtils.esm.js"],"names":["_defineProperty","_typeof","_asyncToGenerator","_classCallCheck","_createClass","_regeneratorRuntime","generatePrivate","getPublic","decrypt","post","generateJsonRPCObject","get","setAPIKey","setEmbedHost","BN","ec","JsonStringify","keccak256","toChecksumAddress","loglevel","_inherits","_possibleConstructorReturn","_getPrototypeOf","_wrapNativeSuper","_toConsumableArray","log","getLogger","disableAll","_createSuper$1","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct$1","_createSuperInternal","Super","result","NewTarget","constructor","Reflect","construct","arguments","apply","sham","Proxy","Boolean","prototype","valueOf","call","e","capitalizeFirstLetter","str","charAt","toUpperCase","slice","SomeError","_Error","_super","_ref","_this","errors","responses","predicate","Error","Some","promises","Promise","resolve","reject","finishedCount","sharedState","resolved","errorArr","Array","length","fill","undefined","resultArr","predicateError","forEach","x","index","then","resp","catch","error","finally","data","_","Object","values","reduce","acc","z","_error$data","_ref2","id","startsWith","msg","concat","map","it","join","_predicateError","message","ownKeys$1","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","_objectSpread$1","target","i","source","key","getOwnPropertyDescriptors","defineProperties","defineProperty","_createSuper","_isNativeReflectConstruct","GetOrSetNonceError","kCombinations","s","k","set","from","cur","combs","tailCombs","j","thresholdSame","arr","t","hashMap","keyLookup","mark","_callee","endpoints","verifier","verifierId","lookupPromises","wrap","_callee$","_context","prev","next","verifier_id","toString","err","abrupt","lookupResults","lookupShares","x1","errorResult","x2","keyResult","x3","JSON","stringify","stop","_x","_x2","_x3","waitKeyLookup","timeout","setTimeout","keyAssign","_callee2","torusNodePubs","lastPoint","firstPoint","nodeNum","initialPoint","signedData","acceptedErrorMsgs","_callee2$","_context2","Math","floor","random","headers","pubKeyX","X","pubKeyY","Y","useAPIKey","sent","t0","includes","_x4","_x5","_x6","_x7","_x8","_x9","ownKeys","_objectSpread","Torus","_ref$enableOneKey","enableOneKey","_ref$metadataHost","metadataHost","_ref$allowHost","allowHost","_ref$serverTimeOffset","serverTimeOffset","value","_getUserTypeAndAddress","doesKeyAssign","_ref3","isNewKey","finalKeyResult","assignResult","_finalKeyResult$keys$","typeOfUser","nonce","pubNonce","modifiedPubKey","upgraded","_yield$this$getOrSetN","finalX","finalY","address","_args","t1","pub_key_X","pub_key_Y","getOrSetNonce","t2","keyFromPublic","y","add","keyFromPrivate","getX","getY","generateAddressFromPubKey","getUserTypeAndAddress","_setCustomKey","_ref4","privKeyHex","metadataNonce","torusKeyHex","customKeyHex","torusKey","privKey","customKey","newMetadataNonce","sub","umod","curve","n","generateMetadataParams","setMetadata","setCustomKey","_retrieveShares","_callee5","indexes","verifierParams","idToken","extraParams","promiseArr","tmpKey","pubKey","tokenCommitment","p","_args5","_callee5$","_context5","messageprefix","tokencommitment","temppubx","temppuby","verifieridentifier","completedRequests","promiseArrRequest","nodeSigs","_i","_i2","_p","encrypted","item","idtoken","nodesignatures","_ref5","_callee3","shareResponses","thresholdPublicKey","sharePromises","nodeIndex","_i3","metadata","sharesResolved","decryptedShares","allCombis","privateKey","_loop","_ret","_callee3$","_context3","PublicKey","sort","a","b","Index","cmp","Metadata","ephemPublicKey","Buffer","iv","mac","mode","ciphertext","atob","Share","padStart","debug","all","curr","currentCombi","currentCombiShares","v","shares","indices","derivedPrivateKey","lagrangeInterpolation","decryptedPubKey","decryptedPubKeyX","decryptedPubKeyY","_x10","_x11","_ref6","_callee4","returnedKey","_yield$_this$getNonce","ethAddress","_callee4$","_context4","getNonce","getMetadata","generateAddressFromPrivKey","_x12","retrieveShares","_getMetadata","_callee6","options","metadataResponse","_callee6$","_context6","_x13","_x14","setData","timestamp","Date","now","sig","sign","set_data","signature","r","_setMetadata","_callee7","_callee7$","_context7","_x15","_x16","secret","upper","lower","mul","neg","temp","delta","invm","publicKey","encode","ethAddressLower","publicKeyX","publicKeyY","_getPublicAddress","_callee8","_ref7","isExtended","_ref8","_nonce","_finalKeyResult$keys$2","_yield$this$getOrSetN2","_args8","_callee8$","_context8","getPublicAddress","_x17","_x18","_x19","_getOrSetNonce","_callee9","getOnly","_args9","_callee9$","_context9","_x20","_x21","_x22","_getNonce","_callee10","_callee10$","_context10","_x23","_x24","_x25","getPostboxKeyFrom1OutOf1","privKeyBN","nonceBN","enableLogging","enableAll","setAPIKey$1","apiKey","setEmbedHost$1","embedHost","isGetOrSetNonceError","default"],"mappings":"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","sourcesContent":["import _defineProperty from '@babel/runtime/helpers/defineProperty';\nimport _typeof from '@babel/runtime/helpers/typeof';\nimport _asyncToGenerator from '@babel/runtime/helpers/asyncToGenerator';\nimport _classCallCheck from '@babel/runtime/helpers/classCallCheck';\nimport _createClass from '@babel/runtime/helpers/createClass';\nimport _regeneratorRuntime from '@babel/runtime/regenerator';\nimport { generatePrivate, getPublic, decrypt } from '@toruslabs/eccrypto';\nimport { post, generateJsonRPCObject, get, setAPIKey, setEmbedHost } from '@toruslabs/http-helpers';\nimport BN from 'bn.js';\nimport { ec } from 'elliptic';\nimport JsonStringify from 'json-stable-stringify';\nimport { keccak256, toChecksumAddress } from 'web3-utils';\nimport loglevel from 'loglevel';\nimport _inherits from '@babel/runtime/helpers/inherits';\nimport _possibleConstructorReturn from '@babel/runtime/helpers/possibleConstructorReturn';\nimport _getPrototypeOf from '@babel/runtime/helpers/getPrototypeOf';\nimport _wrapNativeSuper from '@babel/runtime/helpers/wrapNativeSuper';\nimport _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';\n\nvar log = loglevel.getLogger('torus.js');\nlog.disableAll();\n\nfunction _createSuper$1(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct$1(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct$1() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\nfunction capitalizeFirstLetter(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nvar SomeError = /*#__PURE__*/function (_Error) {\n  _inherits(SomeError, _Error);\n\n  var _super = _createSuper$1(SomeError);\n\n  function SomeError(_ref) {\n    var _this;\n\n    var errors = _ref.errors,\n        responses = _ref.responses,\n        predicate = _ref.predicate;\n\n    _classCallCheck(this, SomeError);\n\n    _this = _super.call(this, 'Unable to resolve enough promises.');\n    _this.errors = errors;\n    _this.responses = responses;\n    _this.predicate = predicate;\n    return _this;\n  }\n\n  return _createClass(SomeError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\nvar Some = function Some(promises, predicate) {\n  return new Promise(function (resolve, reject) {\n    var finishedCount = 0;\n    var sharedState = {\n      resolved: false\n    };\n    var errorArr = new Array(promises.length).fill(undefined);\n    var resultArr = new Array(promises.length).fill(undefined);\n    var predicateError;\n    promises.forEach(function (x, index) {\n      x.then(function (resp) {\n        resultArr[index] = resp;\n        return undefined;\n      }).catch(function (error) {\n        errorArr[index] = error;\n      }).finally(function () {\n        if (sharedState.resolved) return;\n        predicate(resultArr.slice(0), sharedState).then(function (data) {\n          sharedState.resolved = true;\n          resolve(data);\n          return undefined;\n        }).catch(function (error) {\n          // log only the last predicate error\n          predicateError = error;\n        }).finally(function (_) {\n          finishedCount += 1;\n\n          if (finishedCount === promises.length) {\n            var errors = Object.values(resultArr.reduce(function (acc, z) {\n              var _error$data;\n\n              var _ref2 = z || {},\n                  id = _ref2.id,\n                  error = _ref2.error;\n\n              if ((error === null || error === void 0 ? void 0 : (_error$data = error.data) === null || _error$data === void 0 ? void 0 : _error$data.length) > 0) {\n                if (error.data.startsWith('Error occurred while verifying params')) acc[id] = capitalizeFirstLetter(error.data);else acc[id] = error.data;\n              }\n\n              return acc;\n            }, {}));\n\n            if (errors.length > 0) {\n              // Format-able errors\n              var msg = errors.length > 1 ? \"\\n\".concat(errors.map(function (it) {\n                return \"\\u2022 \".concat(it);\n              }).join('\\n')) : errors[0];\n              reject(new Error(msg));\n            } else {\n              var _predicateError;\n\n              reject(new SomeError({\n                errors: errorArr,\n                responses: resultArr,\n                predicate: ((_predicateError = predicateError) === null || _predicateError === void 0 ? void 0 : _predicateError.message) || predicateError\n              }));\n            }\n          }\n        });\n      });\n    });\n  });\n};\n\nfunction ownKeys$1(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread$1(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys$1(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys$1(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\nvar GetOrSetNonceError = /*#__PURE__*/function (_Error) {\n  _inherits(GetOrSetNonceError, _Error);\n\n  var _super = _createSuper(GetOrSetNonceError);\n\n  function GetOrSetNonceError() {\n    _classCallCheck(this, GetOrSetNonceError);\n\n    return _super.apply(this, arguments);\n  }\n\n  return _createClass(GetOrSetNonceError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\nvar kCombinations = function kCombinations(s, k) {\n  var set = s;\n\n  if (typeof set === 'number') {\n    set = Array.from({\n      length: set\n    }, function (_, i) {\n      return i;\n    });\n  }\n\n  if (k > set.length || k <= 0) {\n    return [];\n  }\n\n  if (k === set.length) {\n    return [set];\n  }\n\n  if (k === 1) {\n    return set.reduce(function (acc, cur) {\n      return [].concat(_toConsumableArray(acc), [[cur]]);\n    }, []);\n  }\n\n  var combs = [];\n  var tailCombs = [];\n\n  for (var i = 0; i <= set.length - k + 1; i += 1) {\n    tailCombs = kCombinations(set.slice(i + 1), k - 1);\n\n    for (var j = 0; j < tailCombs.length; j += 1) {\n      combs.push([set[i]].concat(_toConsumableArray(tailCombs[j])));\n    }\n  }\n\n  return combs;\n};\nvar thresholdSame = function thresholdSame(arr, t) {\n  var hashMap = {};\n\n  for (var i = 0; i < arr.length; i += 1) {\n    var str = JsonStringify(arr[i]);\n    hashMap[str] = hashMap[str] ? hashMap[str] + 1 : 1;\n\n    if (hashMap[str] === t) {\n      return arr[i];\n    }\n  }\n\n  return undefined;\n};\nvar keyLookup = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(endpoints, verifier, verifierId) {\n    var lookupPromises;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            lookupPromises = endpoints.map(function (x) {\n              return post(x, generateJsonRPCObject('VerifierLookupRequest', {\n                verifier: verifier,\n                verifier_id: verifierId.toString()\n              })).catch(function (err) {\n                return log.error('lookup request failed', err);\n              });\n            });\n            return _context.abrupt(\"return\", Some(lookupPromises, function (lookupResults) {\n              var lookupShares = lookupResults.filter(function (x1) {\n                return x1;\n              });\n              var errorResult = thresholdSame(lookupShares.map(function (x2) {\n                return x2 && x2.error;\n              }), ~~(endpoints.length / 2) + 1);\n              var keyResult = thresholdSame(lookupShares.map(function (x3) {\n                return x3 && x3.result;\n              }), ~~(endpoints.length / 2) + 1);\n\n              if (keyResult || errorResult) {\n                return Promise.resolve({\n                  keyResult: keyResult,\n                  errorResult: errorResult\n                });\n              }\n\n              return Promise.reject(new Error(\"invalid results \".concat(JSON.stringify(lookupResults))));\n            }));\n\n          case 2:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function keyLookup(_x, _x2, _x3) {\n    return _ref.apply(this, arguments);\n  };\n}();\nvar waitKeyLookup = function waitKeyLookup(endpoints, verifier, verifierId, timeout) {\n  return new Promise(function (resolve, reject) {\n    setTimeout(function () {\n      keyLookup(endpoints, verifier, verifierId).then(resolve).catch(reject);\n    }, timeout);\n  });\n};\nvar keyAssign = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(endpoints, torusNodePubs, lastPoint, firstPoint, verifier, verifierId) {\n    var nodeNum, initialPoint, data, signedData, acceptedErrorMsgs;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (lastPoint === undefined) {\n              nodeNum = Math.floor(Math.random() * endpoints.length);\n              initialPoint = nodeNum;\n            } else {\n              nodeNum = lastPoint % endpoints.length;\n            }\n\n            if (!(nodeNum === firstPoint)) {\n              _context2.next = 3;\n              break;\n            }\n\n            throw new Error('Looped through all');\n\n          case 3:\n            if (firstPoint !== undefined) initialPoint = firstPoint;\n            data = generateJsonRPCObject('KeyAssign', {\n              verifier: verifier,\n              verifier_id: verifierId.toString()\n            });\n            _context2.prev = 5;\n            _context2.next = 8;\n            return post('https://signer.tor.us/api/sign', data, {\n              headers: {\n                pubKeyX: torusNodePubs[nodeNum].X,\n                pubKeyY: torusNodePubs[nodeNum].Y\n              }\n            }, {\n              useAPIKey: true\n            });\n\n          case 8:\n            signedData = _context2.sent;\n            return _context2.abrupt(\"return\", post(endpoints[nodeNum], _objectSpread$1(_objectSpread$1({}, data), signedData), {\n              headers: {\n                'Content-Type': 'application/json; charset=utf-8'\n              }\n            }));\n\n          case 12:\n            _context2.prev = 12;\n            _context2.t0 = _context2[\"catch\"](5);\n            log.error(_context2.t0);\n            acceptedErrorMsgs = [// Slow node\n            'Timed out', // Happens when the node is not reachable (dns issue etc)\n            'TypeError: Failed to fetch', // All except iOS and Firefox\n            'TypeError: cancelled', // iOS\n            'TypeError: NetworkError when attempting to fetch resource.' // Firefox\n            ];\n\n            if (!acceptedErrorMsgs.includes(_context2.t0.message)) {\n              _context2.next = 18;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", keyAssign(endpoints, torusNodePubs, nodeNum + 1, initialPoint, verifier, verifierId));\n\n          case 18:\n            throw new Error(\"Sorry, the Torus Network that powers Web3Auth is currently very busy.\\n    We will generate your key in time. Pls try again later. \\n\\n    \".concat(_context2.t0.message || ''));\n\n          case 19:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[5, 12]]);\n  }));\n\n  return function keyAssign(_x4, _x5, _x6, _x7, _x8, _x9) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n// of Torus nodes to handle malicious node responses\n\nvar Torus = /*#__PURE__*/function () {\n  function Torus() {\n    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n        _ref$enableOneKey = _ref.enableOneKey,\n        enableOneKey = _ref$enableOneKey === void 0 ? false : _ref$enableOneKey,\n        _ref$metadataHost = _ref.metadataHost,\n        metadataHost = _ref$metadataHost === void 0 ? 'https://metadata.tor.us' : _ref$metadataHost,\n        _ref$allowHost = _ref.allowHost,\n        allowHost = _ref$allowHost === void 0 ? 'https://signer.tor.us/api/allow' : _ref$allowHost,\n        _ref$serverTimeOffset = _ref.serverTimeOffset,\n        serverTimeOffset = _ref$serverTimeOffset === void 0 ? 0 : _ref$serverTimeOffset;\n\n    _classCallCheck(this, Torus);\n\n    this.ec = new ec('secp256k1');\n    this.metadataHost = metadataHost;\n    this.allowHost = allowHost;\n    this.enableOneKey = enableOneKey;\n    this.serverTimeOffset = serverTimeOffset || 0; // ms\n  }\n\n  _createClass(Torus, [{\n    key: \"getUserTypeAndAddress\",\n    value:\n    /**\n     * Note: use this function only for openlogin tkey account lookups.\n     */\n    function () {\n      var _getUserTypeAndAddress = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(endpoints, torusNodePubs, _ref2) {\n        var verifier,\n            verifierId,\n            doesKeyAssign,\n            _ref3,\n            keyResult,\n            errorResult,\n            isNewKey,\n            finalKeyResult,\n            assignResult,\n            _finalKeyResult$keys$,\n            X,\n            Y,\n            typeOfUser,\n            nonce,\n            pubNonce,\n            modifiedPubKey,\n            upgraded,\n            _yield$this$getOrSetN,\n            finalX,\n            finalY,\n            address,\n            _args = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                verifier = _ref2.verifier, verifierId = _ref2.verifierId;\n                doesKeyAssign = _args.length > 3 && _args[3] !== undefined ? _args[3] : false;\n                _context.next = 4;\n                return keyLookup(endpoints, verifier, verifierId);\n\n              case 4:\n                _context.t0 = _context.sent;\n\n                if (_context.t0) {\n                  _context.next = 7;\n                  break;\n                }\n\n                _context.t0 = {};\n\n              case 7:\n                _ref3 = _context.t0;\n                keyResult = _ref3.keyResult;\n                errorResult = _ref3.errorResult;\n                isNewKey = false;\n\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier + VerifierID has not yet been assigned'))) {\n                  _context.next = 26;\n                  break;\n                }\n\n                if (doesKeyAssign) {\n                  _context.next = 14;\n                  break;\n                }\n\n                throw new Error('Verifier + VerifierID has not yet been assigned');\n\n              case 14:\n                _context.next = 16;\n                return keyAssign(endpoints, torusNodePubs, undefined, undefined, verifier, verifierId);\n\n              case 16:\n                _context.next = 18;\n                return waitKeyLookup(endpoints, verifier, verifierId, 1000);\n\n              case 18:\n                _context.t1 = _context.sent;\n\n                if (_context.t1) {\n                  _context.next = 21;\n                  break;\n                }\n\n                _context.t1 = {};\n\n              case 21:\n                assignResult = _context.t1;\n                finalKeyResult = assignResult.keyResult;\n                isNewKey = true;\n                _context.next = 31;\n                break;\n\n              case 26:\n                if (!keyResult) {\n                  _context.next = 30;\n                  break;\n                }\n\n                finalKeyResult = keyResult;\n                _context.next = 31;\n                break;\n\n              case 30:\n                throw new Error(\"node results do not match at first lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 31:\n                if (!finalKeyResult) {\n                  _context.next = 61;\n                  break;\n                }\n\n                _finalKeyResult$keys$ = finalKeyResult.keys[0], X = _finalKeyResult$keys$.pub_key_X, Y = _finalKeyResult$keys$.pub_key_Y;\n                _context.prev = 33;\n                _context.next = 37;\n                return this.getOrSetNonce(X, Y, undefined, !isNewKey);\n\n              case 37:\n                _yield$this$getOrSetN = _context.sent;\n                typeOfUser = _yield$this$getOrSetN.typeOfUser;\n                nonce = _yield$this$getOrSetN.nonce;\n                pubNonce = _yield$this$getOrSetN.pubNonce;\n                upgraded = _yield$this$getOrSetN.upgraded;\n                nonce = new BN(nonce || '0', 16);\n                _context.next = 48;\n                break;\n\n              case 45:\n                _context.prev = 45;\n                _context.t2 = _context[\"catch\"](33);\n                throw new GetOrSetNonceError();\n\n              case 48:\n                if (!(typeOfUser === 'v1')) {\n                  _context.next = 52;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n                _context.next = 57;\n                break;\n\n              case 52:\n                if (!(typeOfUser === 'v2')) {\n                  _context.next = 56;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPublic({\n                  x: pubNonce.x,\n                  y: pubNonce.y\n                }).getPublic());\n                _context.next = 57;\n                break;\n\n              case 56:\n                throw new Error('getOrSetNonce should always return typeOfUser.');\n\n              case 57:\n                finalX = modifiedPubKey.getX().toString(16);\n                finalY = modifiedPubKey.getY().toString(16);\n                address = this.generateAddressFromPubKey(modifiedPubKey.getX(), modifiedPubKey.getY());\n                return _context.abrupt(\"return\", {\n                  typeOfUser: typeOfUser,\n                  nonce: nonce,\n                  pubNonce: pubNonce,\n                  upgraded: upgraded,\n                  X: finalX,\n                  Y: finalY,\n                  address: address\n                });\n\n              case 61:\n                throw new Error(\"node results do not match at final lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 62:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[33, 45]]);\n      }));\n\n      function getUserTypeAndAddress(_x, _x2, _x3) {\n        return _getUserTypeAndAddress.apply(this, arguments);\n      }\n\n      return getUserTypeAndAddress;\n    }()\n  }, {\n    key: \"setCustomKey\",\n    value: function () {\n      var _setCustomKey = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref4) {\n        var privKeyHex, metadataNonce, torusKeyHex, customKeyHex, torusKey, privKey, customKey, newMetadataNonce, data;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                privKeyHex = _ref4.privKeyHex, metadataNonce = _ref4.metadataNonce, torusKeyHex = _ref4.torusKeyHex, customKeyHex = _ref4.customKeyHex;\n\n                if (torusKeyHex) {\n                  torusKey = new BN(torusKeyHex, 16);\n                } else {\n                  privKey = new BN(privKeyHex, 16);\n                  torusKey = privKey.sub(metadataNonce).umod(this.ec.curve.n);\n                }\n\n                customKey = new BN(customKeyHex, 16);\n                newMetadataNonce = customKey.sub(torusKey).umod(this.ec.curve.n);\n                data = this.generateMetadataParams(newMetadataNonce.toString(16), torusKey.toString(16));\n                _context2.next = 7;\n                return this.setMetadata(data);\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function setCustomKey(_x4) {\n        return _setCustomKey.apply(this, arguments);\n      }\n\n      return setCustomKey;\n    }()\n  }, {\n    key: \"retrieveShares\",\n    value: function () {\n      var _retrieveShares = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(endpoints, indexes, verifier, verifierParams, idToken) {\n        var _this = this;\n\n        var extraParams,\n            promiseArr,\n            tmpKey,\n            pubKey,\n            pubKeyX,\n            pubKeyY,\n            tokenCommitment,\n            i,\n            p,\n            _args5 = arguments;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                extraParams = _args5.length > 5 && _args5[5] !== undefined ? _args5[5] : {};\n                promiseArr = [];\n                _context5.next = 4;\n                return get(this.allowHost, {\n                  headers: {\n                    verifier: verifier,\n                    verifier_id: verifierParams.verifier_id\n                  }\n                }, {\n                  useAPIKey: true\n                });\n\n              case 4:\n                /*\n                  CommitmentRequestParams struct {\n                    MessagePrefix      string `json:\"messageprefix\"`\n                    TokenCommitment    string `json:\"tokencommitment\"`\n                    TempPubX           string `json:\"temppubx\"`\n                    TempPubY           string `json:\"temppuby\"`\n                    VerifierIdentifier string `json:\"verifieridentifier\"`\n                  } \n                  */\n                // generate temporary private and public key that is used to secure receive shares\n                tmpKey = generatePrivate();\n                pubKey = getPublic(tmpKey).toString('hex');\n                pubKeyX = pubKey.slice(2, 66);\n                pubKeyY = pubKey.slice(66);\n                tokenCommitment = keccak256(idToken); // make commitment requests to endpoints\n\n                for (i = 0; i < endpoints.length; i += 1) {\n                  p = post(endpoints[i], generateJsonRPCObject('CommitmentRequest', {\n                    messageprefix: 'mug00',\n                    tokencommitment: tokenCommitment.slice(2),\n                    temppubx: pubKeyX,\n                    temppuby: pubKeyY,\n                    verifieridentifier: verifier\n                  })).catch(function (err) {\n                    return log.error('commitment', err);\n                  });\n                  promiseArr.push(p);\n                }\n                /*\n                  ShareRequestParams struct {\n                    Item []bijson.RawMessage `json:\"item\"`\n                  }\n                  ShareRequestItem struct {\n                    IDToken            string          `json:\"idtoken\"`\n                    NodeSignatures     []NodeSignature `json:\"nodesignatures\"`\n                    VerifierIdentifier string          `json:\"verifieridentifier\"`\n                  }\n                  NodeSignature struct {\n                    Signature   string\n                    Data        string\n                    NodePubKeyX string\n                    NodePubKeyY string\n                  }\n                  CommitmentRequestResult struct {\n                    Signature string `json:\"signature\"`\n                    Data      string `json:\"data\"`\n                    NodePubX  string `json:\"nodepubx\"`\n                    NodePubY  string `json:\"nodepuby\"`\n                  }\n                  */\n                // send share request once k + t number of commitment requests have completed\n\n\n                return _context5.abrupt(\"return\", Some(promiseArr, function (resultArr) {\n                  var completedRequests = resultArr.filter(function (x) {\n                    if (!x || _typeof(x) !== 'object') {\n                      return false;\n                    }\n\n                    if (x.error) {\n                      return false;\n                    }\n\n                    return true;\n                  });\n\n                  if (completedRequests.length >= ~~(endpoints.length / 4) * 3 + 1) {\n                    return Promise.resolve(resultArr);\n                  }\n\n                  return Promise.reject(new Error(\"invalid \".concat(JSON.stringify(resultArr))));\n                }).then(function (responses) {\n                  var promiseArrRequest = [];\n                  var nodeSigs = [];\n\n                  for (var _i = 0; _i < responses.length; _i += 1) {\n                    if (responses[_i]) nodeSigs.push(responses[_i].result);\n                  }\n\n                  for (var _i2 = 0; _i2 < endpoints.length; _i2 += 1) {\n                    // eslint-disable-next-line promise/no-nesting\n                    var _p = post(endpoints[_i2], generateJsonRPCObject('ShareRequest', {\n                      encrypted: 'yes',\n                      item: [_objectSpread(_objectSpread({}, verifierParams), {}, {\n                        idtoken: idToken,\n                        nodesignatures: nodeSigs,\n                        verifieridentifier: verifier\n                      }, extraParams)]\n                    })).catch(function (err) {\n                      return log.error('share req', err);\n                    });\n\n                    promiseArrRequest.push(_p);\n                  }\n\n                  return Some(promiseArrRequest, /*#__PURE__*/function () {\n                    var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(shareResponses, sharedState) {\n                      var completedRequests, thresholdPublicKey, sharePromises, nodeIndex, _i3, metadata, sharesResolved, decryptedShares, allCombis, privateKey, _loop, j, _ret;\n\n                      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                        while (1) {\n                          switch (_context3.prev = _context3.next) {\n                            case 0:\n                              /*\n                                  ShareRequestResult struct {\n                                    Keys []KeyAssignment\n                                  }\n                                          / KeyAssignmentPublic -\n                                  type KeyAssignmentPublic struct {\n                                    Index     big.Int\n                                    PublicKey common.Point\n                                    Threshold int\n                                    Verifiers map[string][]string // Verifier => VerifierID\n                                  }\n                                   // KeyAssignment -\n                                  type KeyAssignment struct {\n                                    KeyAssignmentPublic\n                                    Share big.Int // Or Si\n                                  }\n                                */\n                              // check if threshold number of nodes have returned the same user public key\n                              completedRequests = shareResponses.filter(function (x) {\n                                return x;\n                              });\n                              thresholdPublicKey = thresholdSame(shareResponses.map(function (x) {\n                                return x && x.result && x.result.keys[0].PublicKey;\n                              }), ~~(endpoints.length / 2) + 1); // optimistically run lagrange interpolation once threshold number of shares have been received\n                              // this is matched against the user public key to ensure that shares are consistent\n\n                              if (!(completedRequests.length >= ~~(endpoints.length / 2) + 1 && thresholdPublicKey)) {\n                                _context3.next = 25;\n                                break;\n                              }\n\n                              sharePromises = [];\n                              nodeIndex = [];\n\n                              for (_i3 = 0; _i3 < shareResponses.length; _i3 += 1) {\n                                if (shareResponses[_i3] && shareResponses[_i3].result && shareResponses[_i3].result.keys && shareResponses[_i3].result.keys.length > 0) {\n                                  shareResponses[_i3].result.keys.sort(function (a, b) {\n                                    return new BN(a.Index, 16).cmp(new BN(b.Index, 16));\n                                  });\n\n                                  if (shareResponses[_i3].result.keys[0].Metadata) {\n                                    metadata = {\n                                      ephemPublicKey: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.ephemPublicKey, 'hex'),\n                                      iv: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.iv, 'hex'),\n                                      mac: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.mac, 'hex'),\n                                      mode: Buffer.from(shareResponses[_i3].result.keys[0].Metadata.mode, 'hex')\n                                    };\n                                    sharePromises.push( // eslint-disable-next-line promise/no-nesting\n                                    decrypt(tmpKey, _objectSpread(_objectSpread({}, metadata), {}, {\n                                      ciphertext: Buffer.from(atob(shareResponses[_i3].result.keys[0].Share).padStart(64, '0'), 'hex')\n                                    })).catch(function (err) {\n                                      return log.debug('share decryption', err);\n                                    }));\n                                  } else {\n                                    sharePromises.push(Promise.resolve(Buffer.from(shareResponses[_i3].result.keys[0].Share.padStart(64, '0'), 'hex')));\n                                  }\n                                } else {\n                                  sharePromises.push(Promise.resolve(undefined));\n                                }\n\n                                nodeIndex.push(new BN(indexes[_i3], 16));\n                              }\n\n                              _context3.next = 8;\n                              return Promise.all(sharePromises);\n\n                            case 8:\n                              sharesResolved = _context3.sent;\n\n                              if (!sharedState.resolved) {\n                                _context3.next = 11;\n                                break;\n                              }\n\n                              return _context3.abrupt(\"return\", undefined);\n\n                            case 11:\n                              decryptedShares = sharesResolved.reduce(function (acc, curr, index) {\n                                if (curr) acc.push({\n                                  index: nodeIndex[index],\n                                  value: new BN(curr)\n                                });\n                                return acc;\n                              }, []); // run lagrange interpolation on all subsets, faster in the optimistic scenario than berlekamp-welch due to early exit\n\n                              // run lagrange interpolation on all subsets, faster in the optimistic scenario than berlekamp-welch due to early exit\n                              allCombis = kCombinations(decryptedShares.length, ~~(endpoints.length / 2) + 1);\n\n                              _loop = function _loop(j) {\n                                var currentCombi = allCombis[j];\n                                var currentCombiShares = decryptedShares.filter(function (v, index) {\n                                  return currentCombi.includes(index);\n                                });\n                                var shares = currentCombiShares.map(function (x) {\n                                  return x.value;\n                                });\n                                var indices = currentCombiShares.map(function (x) {\n                                  return x.index;\n                                });\n\n                                var derivedPrivateKey = _this.lagrangeInterpolation(shares, indices);\n\n                                var decryptedPubKey = getPublic(Buffer.from(derivedPrivateKey.toString(16, 64), 'hex')).toString('hex');\n                                var decryptedPubKeyX = decryptedPubKey.slice(2, 66);\n                                var decryptedPubKeyY = decryptedPubKey.slice(66);\n\n                                if (new BN(decryptedPubKeyX, 16).cmp(new BN(thresholdPublicKey.X, 16)) === 0 && new BN(decryptedPubKeyY, 16).cmp(new BN(thresholdPublicKey.Y, 16)) === 0) {\n                                  privateKey = derivedPrivateKey;\n                                  return \"break\";\n                                }\n                              };\n\n                              j = 0;\n\n                            case 15:\n                              if (!(j < allCombis.length)) {\n                                _context3.next = 22;\n                                break;\n                              }\n\n                              _ret = _loop(j);\n\n                              if (!(_ret === \"break\")) {\n                                _context3.next = 19;\n                                break;\n                              }\n\n                              return _context3.abrupt(\"break\", 22);\n\n                            case 19:\n                              j += 1;\n                              _context3.next = 15;\n                              break;\n\n                            case 22:\n                              if (!(privateKey === undefined)) {\n                                _context3.next = 24;\n                                break;\n                              }\n\n                              throw new Error('could not derive private key');\n\n                            case 24:\n                              return _context3.abrupt(\"return\", privateKey);\n\n                            case 25:\n                              throw new Error('invalid');\n\n                            case 26:\n                            case \"end\":\n                              return _context3.stop();\n                          }\n                        }\n                      }, _callee3);\n                    }));\n\n                    return function (_x10, _x11) {\n                      return _ref5.apply(this, arguments);\n                    };\n                  }());\n                }).then( /*#__PURE__*/function () {\n                  var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(returnedKey) {\n                    var privateKey, decryptedPubKey, decryptedPubKeyX, decryptedPubKeyY, metadataNonce, _yield$_this$getNonce, nonce, ethAddress;\n\n                    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n                      while (1) {\n                        switch (_context4.prev = _context4.next) {\n                          case 0:\n                            privateKey = returnedKey;\n                            decryptedPubKey = getPublic(Buffer.from(privateKey.toString(16, 64), 'hex')).toString('hex');\n                            decryptedPubKeyX = decryptedPubKey.slice(2, 66);\n                            decryptedPubKeyY = decryptedPubKey.slice(66);\n\n                            if (!_this.enableOneKey) {\n                              _context4.next = 12;\n                              break;\n                            }\n\n                            _context4.next = 7;\n                            return _this.getNonce(decryptedPubKeyX, decryptedPubKeyY, privateKey);\n\n                          case 7:\n                            _yield$_this$getNonce = _context4.sent;\n                            nonce = _yield$_this$getNonce.nonce;\n                            metadataNonce = new BN(nonce || '0', 16);\n                            _context4.next = 15;\n                            break;\n\n                          case 12:\n                            _context4.next = 14;\n                            return _this.getMetadata({\n                              pub_key_X: decryptedPubKeyX,\n                              pub_key_Y: decryptedPubKeyY\n                            });\n\n                          case 14:\n                            metadataNonce = _context4.sent;\n\n                          case 15:\n                            log.debug('> torus.js/retrieveShares', {\n                              privKey: privateKey.toString(16),\n                              metadataNonce: metadataNonce.toString(16)\n                            });\n                            privateKey = privateKey.add(metadataNonce).umod(_this.ec.curve.n);\n                            ethAddress = _this.generateAddressFromPrivKey(privateKey);\n                            log.debug('> torus.js/retrieveShares', {\n                              ethAddress: ethAddress,\n                              privKey: privateKey.toString(16)\n                            }); // return reconstructed private key and ethereum address\n\n                            return _context4.abrupt(\"return\", {\n                              ethAddress: ethAddress,\n                              privKey: privateKey.toString('hex', 64),\n                              metadataNonce: metadataNonce\n                            });\n\n                          case 20:\n                          case \"end\":\n                            return _context4.stop();\n                        }\n                      }\n                    }, _callee4);\n                  }));\n\n                  return function (_x12) {\n                    return _ref6.apply(this, arguments);\n                  };\n                }()));\n\n              case 11:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function retrieveShares(_x5, _x6, _x7, _x8, _x9) {\n        return _retrieveShares.apply(this, arguments);\n      }\n\n      return retrieveShares;\n    }()\n  }, {\n    key: \"getMetadata\",\n    value: function () {\n      var _getMetadata = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(data, options) {\n        var metadataResponse;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.prev = 0;\n                _context6.next = 3;\n                return post(\"\".concat(this.metadataHost, \"/get\"), data, options, {\n                  useAPIKey: true\n                });\n\n              case 3:\n                metadataResponse = _context6.sent;\n\n                if (!(!metadataResponse || !metadataResponse.message)) {\n                  _context6.next = 6;\n                  break;\n                }\n\n                return _context6.abrupt(\"return\", new BN(0));\n\n              case 6:\n                return _context6.abrupt(\"return\", new BN(metadataResponse.message, 16));\n\n              case 9:\n                _context6.prev = 9;\n                _context6.t0 = _context6[\"catch\"](0);\n                log.error('get metadata error', _context6.t0);\n                return _context6.abrupt(\"return\", new BN(0));\n\n              case 13:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this, [[0, 9]]);\n      }));\n\n      function getMetadata(_x13, _x14) {\n        return _getMetadata.apply(this, arguments);\n      }\n\n      return getMetadata;\n    }()\n  }, {\n    key: \"generateMetadataParams\",\n    value: function generateMetadataParams(message, privateKey) {\n      var key = this.ec.keyFromPrivate(privateKey.toString('hex', 64));\n      var setData = {\n        data: message,\n        timestamp: new BN(~~(this.serverTimeOffset + Date.now() / 1000)).toString(16)\n      };\n      var sig = key.sign(keccak256(JsonStringify(setData)).slice(2));\n      return {\n        pub_key_X: key.getPublic().getX().toString('hex'),\n        pub_key_Y: key.getPublic().getY().toString('hex'),\n        set_data: setData,\n        signature: Buffer.from(sig.r.toString(16, 64) + sig.s.toString(16, 64) + new BN(sig.v).toString(16, 2), 'hex').toString('base64')\n      };\n    }\n  }, {\n    key: \"setMetadata\",\n    value: function () {\n      var _setMetadata = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(data, options) {\n        var metadataResponse;\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.prev = 0;\n                _context7.next = 3;\n                return post(\"\".concat(this.metadataHost, \"/set\"), data, options, {\n                  useAPIKey: true\n                });\n\n              case 3:\n                metadataResponse = _context7.sent;\n                return _context7.abrupt(\"return\", metadataResponse.message);\n\n              case 7:\n                _context7.prev = 7;\n                _context7.t0 = _context7[\"catch\"](0);\n                log.error('set metadata error', _context7.t0);\n                return _context7.abrupt(\"return\", '');\n\n              case 11:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this, [[0, 7]]);\n      }));\n\n      function setMetadata(_x15, _x16) {\n        return _setMetadata.apply(this, arguments);\n      }\n\n      return setMetadata;\n    }()\n  }, {\n    key: \"lagrangeInterpolation\",\n    value: function lagrangeInterpolation(shares, nodeIndex) {\n      if (shares.length !== nodeIndex.length) {\n        return null;\n      }\n\n      var secret = new BN(0);\n\n      for (var i = 0; i < shares.length; i += 1) {\n        var upper = new BN(1);\n        var lower = new BN(1);\n\n        for (var j = 0; j < shares.length; j += 1) {\n          if (i !== j) {\n            upper = upper.mul(nodeIndex[j].neg());\n            upper = upper.umod(this.ec.curve.n);\n            var temp = nodeIndex[i].sub(nodeIndex[j]);\n            temp = temp.umod(this.ec.curve.n);\n            lower = lower.mul(temp).umod(this.ec.curve.n);\n          }\n        }\n\n        var delta = upper.mul(lower.invm(this.ec.curve.n)).umod(this.ec.curve.n);\n        delta = delta.mul(shares[i]).umod(this.ec.curve.n);\n        secret = secret.add(delta);\n      }\n\n      return secret.umod(this.ec.curve.n);\n    }\n  }, {\n    key: \"generateAddressFromPrivKey\",\n    value: function generateAddressFromPrivKey(privateKey) {\n      var key = this.ec.keyFromPrivate(privateKey.toString('hex', 64), 'hex');\n      var publicKey = key.getPublic().encode('hex').slice(2);\n      var ethAddressLower = \"0x\".concat(keccak256(Buffer.from(publicKey, 'hex')).slice(64 - 38));\n      return toChecksumAddress(ethAddressLower);\n    }\n  }, {\n    key: \"generateAddressFromPubKey\",\n    value: function generateAddressFromPubKey(publicKeyX, publicKeyY) {\n      var key = this.ec.keyFromPublic({\n        x: publicKeyX.toString('hex', 64),\n        y: publicKeyY.toString('hex', 64)\n      });\n      var publicKey = key.getPublic().encode('hex').slice(2);\n      var ethAddressLower = \"0x\".concat(keccak256(Buffer.from(publicKey, 'hex')).slice(64 - 38));\n      return toChecksumAddress(ethAddressLower);\n    }\n    /**\n     * Note: use this function only with custom auth, don't use to lookup openlogin accounts.\n     */\n\n  }, {\n    key: \"getPublicAddress\",\n    value: function () {\n      var _getPublicAddress = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(endpoints, torusNodePubs, _ref7) {\n        var verifier,\n            verifierId,\n            isExtended,\n            finalKeyResult,\n            isNewKey,\n            _ref8,\n            keyResult,\n            errorResult,\n            assignResult,\n            _nonce,\n            _finalKeyResult$keys$2,\n            X,\n            Y,\n            typeOfUser,\n            nonce,\n            pubNonce,\n            modifiedPubKey,\n            upgraded,\n            _yield$this$getOrSetN2,\n            address,\n            _args8 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                verifier = _ref7.verifier, verifierId = _ref7.verifierId;\n                isExtended = _args8.length > 3 && _args8[3] !== undefined ? _args8[3] : false;\n                log.debug('> torus.js/getPublicAddress', {\n                  endpoints: endpoints,\n                  torusNodePubs: torusNodePubs,\n                  verifier: verifier,\n                  verifierId: verifierId,\n                  isExtended: isExtended\n                });\n                isNewKey = false;\n                _context8.next = 6;\n                return keyLookup(endpoints, verifier, verifierId);\n\n              case 6:\n                _context8.t0 = _context8.sent;\n\n                if (_context8.t0) {\n                  _context8.next = 9;\n                  break;\n                }\n\n                _context8.t0 = {};\n\n              case 9:\n                _ref8 = _context8.t0;\n                keyResult = _ref8.keyResult;\n                errorResult = _ref8.errorResult;\n\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier not supported'))) {\n                  _context8.next = 16;\n                  break;\n                }\n\n                throw new Error(\"Verifier not supported. Check if you: \\n\\n      1. Are on the right network (Torus testnet/mainnet) \\n\\n      2. Have setup a verifier on dashboard.web3auth.io?\");\n\n              case 16:\n                if (!(errorResult && JSON.stringify(errorResult).includes('Verifier + VerifierID has not yet been assigned'))) {\n                  _context8.next = 29;\n                  break;\n                }\n\n                _context8.next = 19;\n                return keyAssign(endpoints, torusNodePubs, undefined, undefined, verifier, verifierId);\n\n              case 19:\n                _context8.next = 21;\n                return waitKeyLookup(endpoints, verifier, verifierId, 1000);\n\n              case 21:\n                _context8.t1 = _context8.sent;\n\n                if (_context8.t1) {\n                  _context8.next = 24;\n                  break;\n                }\n\n                _context8.t1 = {};\n\n              case 24:\n                assignResult = _context8.t1;\n                finalKeyResult = assignResult.keyResult;\n                isNewKey = true;\n                _context8.next = 34;\n                break;\n\n              case 29:\n                if (!keyResult) {\n                  _context8.next = 33;\n                  break;\n                }\n\n                finalKeyResult = keyResult;\n                _context8.next = 34;\n                break;\n\n              case 33:\n                throw new Error(\"node results do not match at first lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 34:\n                log.debug('> torus.js/getPublicAddress', {\n                  finalKeyResult: finalKeyResult,\n                  isNewKey: isNewKey\n                });\n\n                if (!finalKeyResult) {\n                  _context8.next = 76;\n                  break;\n                }\n\n                _finalKeyResult$keys$2 = finalKeyResult.keys[0], X = _finalKeyResult$keys$2.pub_key_X, Y = _finalKeyResult$keys$2.pub_key_Y;\n\n                if (!this.enableOneKey) {\n                  _context8.next = 64;\n                  break;\n                }\n\n                _context8.prev = 38;\n                _context8.next = 42;\n                return this.getOrSetNonce(X, Y, undefined, !isNewKey);\n\n              case 42:\n                _yield$this$getOrSetN2 = _context8.sent;\n                typeOfUser = _yield$this$getOrSetN2.typeOfUser;\n                nonce = _yield$this$getOrSetN2.nonce;\n                pubNonce = _yield$this$getOrSetN2.pubNonce;\n                upgraded = _yield$this$getOrSetN2.upgraded;\n                nonce = new BN(nonce || '0', 16);\n                _context8.next = 53;\n                break;\n\n              case 50:\n                _context8.prev = 50;\n                _context8.t2 = _context8[\"catch\"](38);\n                throw new GetOrSetNonceError();\n\n              case 53:\n                if (!(typeOfUser === 'v1')) {\n                  _context8.next = 57;\n                  break;\n                }\n\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n                _context8.next = 62;\n                break;\n\n              case 57:\n                if (!(typeOfUser === 'v2')) {\n                  _context8.next = 61;\n                  break;\n                }\n\n                if (upgraded) {\n                  // OneKey is upgraded to 2/n, returned address is address of Torus key (postbox key), not tKey\n                  modifiedPubKey = this.ec.keyFromPublic({\n                    x: X.toString(16),\n                    y: Y.toString(16)\n                  }).getPublic();\n                } else {\n                  modifiedPubKey = this.ec.keyFromPublic({\n                    x: X.toString(16),\n                    y: Y.toString(16)\n                  }).getPublic().add(this.ec.keyFromPublic({\n                    x: pubNonce.x,\n                    y: pubNonce.y\n                  }).getPublic());\n                }\n\n                _context8.next = 62;\n                break;\n\n              case 61:\n                throw new Error('getOrSetNonce should always return typeOfUser.');\n\n              case 62:\n                _context8.next = 69;\n                break;\n\n              case 64:\n                typeOfUser = 'v1';\n                _context8.next = 67;\n                return this.getMetadata({\n                  pub_key_X: X,\n                  pub_key_Y: Y\n                });\n\n              case 67:\n                nonce = _context8.sent;\n                modifiedPubKey = this.ec.keyFromPublic({\n                  x: X.toString(16),\n                  y: Y.toString(16)\n                }).getPublic().add(this.ec.keyFromPrivate(nonce.toString(16)).getPublic());\n\n              case 69:\n                X = modifiedPubKey.getX().toString(16);\n                Y = modifiedPubKey.getY().toString(16);\n                address = this.generateAddressFromPubKey(modifiedPubKey.getX(), modifiedPubKey.getY());\n                log.debug('> torus.js/getPublicAddress', {\n                  X: X,\n                  Y: Y,\n                  address: address,\n                  typeOfUser: typeOfUser,\n                  nonce: (_nonce = nonce) === null || _nonce === void 0 ? void 0 : _nonce.toString(16),\n                  pubNonce: pubNonce\n                });\n\n                if (isExtended) {\n                  _context8.next = 75;\n                  break;\n                }\n\n                return _context8.abrupt(\"return\", address);\n\n              case 75:\n                return _context8.abrupt(\"return\", {\n                  typeOfUser: typeOfUser,\n                  address: address,\n                  X: X,\n                  Y: Y,\n                  metadataNonce: nonce,\n                  pubNonce: pubNonce\n                });\n\n              case 76:\n                throw new Error(\"node results do not match at final lookup \".concat(JSON.stringify(keyResult || {}), \", \").concat(JSON.stringify(errorResult || {})));\n\n              case 77:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[38, 50]]);\n      }));\n\n      function getPublicAddress(_x17, _x18, _x19) {\n        return _getPublicAddress.apply(this, arguments);\n      }\n\n      return getPublicAddress;\n    }()\n    /**\n     * Internal functions for OneKey (OpenLogin v2), only call these functions if you know what you're doing\n     */\n\n  }, {\n    key: \"getOrSetNonce\",\n    value: function () {\n      var _getOrSetNonce = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9(X, Y, privKey) {\n        var getOnly,\n            data,\n            msg,\n            _args9 = arguments;\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                getOnly = _args9.length > 3 && _args9[3] !== undefined ? _args9[3] : false;\n                msg = getOnly ? 'getNonce' : 'getOrSetNonce';\n\n                if (privKey) {\n                  data = this.generateMetadataParams(msg, privKey);\n                } else {\n                  data = {\n                    pub_key_X: X,\n                    pub_key_Y: Y,\n                    set_data: {\n                      data: msg\n                    }\n                  };\n                }\n\n                return _context9.abrupt(\"return\", post(\"\".concat(this.metadataHost, \"/get_or_set_nonce\"), data, undefined, {\n                  useAPIKey: true\n                }));\n\n              case 4:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function getOrSetNonce(_x20, _x21, _x22) {\n        return _getOrSetNonce.apply(this, arguments);\n      }\n\n      return getOrSetNonce;\n    }()\n  }, {\n    key: \"getNonce\",\n    value: function () {\n      var _getNonce = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10(X, Y, privKey) {\n        return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                return _context10.abrupt(\"return\", this.getOrSetNonce(X, Y, privKey, true));\n\n              case 1:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function getNonce(_x23, _x24, _x25) {\n        return _getNonce.apply(this, arguments);\n      }\n\n      return getNonce;\n    }()\n  }, {\n    key: \"getPostboxKeyFrom1OutOf1\",\n    value: function getPostboxKeyFrom1OutOf1(privKey, nonce) {\n      var privKeyBN = new BN(privKey, 16);\n      var nonceBN = new BN(nonce, 16);\n      return privKeyBN.sub(nonceBN).umod(this.ec.curve.n).toString('hex');\n    }\n  }], [{\n    key: \"enableLogging\",\n    value: function enableLogging() {\n      var v = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      if (v) log.enableAll();else log.disableAll();\n    }\n  }, {\n    key: \"setAPIKey\",\n    value: function setAPIKey$1(apiKey) {\n      setAPIKey(apiKey);\n    }\n  }, {\n    key: \"setEmbedHost\",\n    value: function setEmbedHost$1(embedHost) {\n      setEmbedHost(embedHost);\n    }\n  }, {\n    key: \"isGetOrSetNonceError\",\n    value: function isGetOrSetNonceError(err) {\n      return err instanceof GetOrSetNonceError;\n    }\n  }]);\n\n  return Torus;\n}();\n\nexport { Torus as default, keyAssign, keyLookup, waitKeyLookup };\n"]},"metadata":{},"sourceType":"module"}